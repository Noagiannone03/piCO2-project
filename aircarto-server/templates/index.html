<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pico - Dashboard CO2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Couleurs Apple-like subtiles */
            --primary: #007AFF;
            --primary-light: #5AC8FA;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --info: #5AC8FA;
            
            /* Backgrounds subtils */
            --bg-primary: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-surface: #F7F7F7;
            --bg-hover: #F5F5F7;
            --bg-accent: rgba(0, 122, 255, 0.08);
            
            /* Textes élégants */
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #6E6E73;
            --text-accent: #007AFF;
            
            /* Bordures douces */
            --border-light: #E5E5E7;
            --border-medium: #D1D1D6;
            
            /* Ombres Apple-style */
            --shadow-soft: 0 2px 16px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.12);
            
            /* Rayons de courbure */
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
        }

        /* Header moderne et élégant */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 3rem 0 4rem 0;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><circle cx="200" cy="50" r="3"/><circle cx="400" cy="30" r="2"/><circle cx="600" cy="70" r="2.5"/><circle cx="800" cy="40" r="1.5"/></svg>');
            background-size: cover;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.25rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Container avec grille responsive */
        .main-container {
            max-width: 1200px;
            margin: -2rem auto 0;
            padding: 0 2rem 2rem;
            position: relative;
            z-index: 2;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Cards avec style Apple */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-large);
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Boutons style Apple avec effet enfoncé */
        .btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-medium);
            border-bottom-width: 4px;
            border-right-width: 3px;
            border-radius: var(--radius-medium);
            padding: 0.875rem 1.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            transform: translate(1px, 1px);
            border-bottom-width: 3px;
            border-right-width: 2px;
            background: var(--bg-hover);
        }

        .btn:active {
            transform: translate(2px, 2px);
            border-bottom-width: 2px;
            border-right-width: 2px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: #0056CC;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: #248A3D;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border-color: #CC7A00;
        }

        /* Stats overview améliorées */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-large);
            padding: 2rem 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-light);
            position: relative;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* CO2 principal élégant */
        .co2-main {
            text-align: center;
            padding: 3rem 2rem;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-light);
            position: relative;
        }

        .co2-current {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .co2-unit {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .air-quality-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        /* Couleurs air quality subtiles */
        .excellent { 
            background: linear-gradient(135deg, var(--success) 0%, #28A745 100%); 
            color: white; 
        }
        .good { 
            background: linear-gradient(135deg, #40E0D0 0%, var(--info) 100%); 
            color: white; 
        }
        .medium { 
            background: linear-gradient(135deg, var(--warning) 0%, #FFB84D 100%); 
            color: white; 
        }
        .bad { 
            background: linear-gradient(135deg, #FF6B47 0%, var(--danger) 100%); 
            color: white; 
        }
        .danger { 
            background: linear-gradient(135deg, var(--danger) 0%, #CC1F1A 100%); 
            color: white; 
        }

        /* Cartes latérales */
        .weather-card {
            background: linear-gradient(135deg, var(--info) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: var(--radius-large);
            padding: 1.5rem;
            text-align: center;
            border: none;
        }

        .weather-temp {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .weather-desc {
            font-size: 1rem;
            opacity: 0.9;
        }

        .advice-card {
            background: var(--bg-accent);
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: var(--radius-large);
            padding: 1.5rem;
            position: relative;
        }

        .advice-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .advice-text {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .tips-card {
            background: linear-gradient(135deg, #FFF8E7 0%, #FFF2CC 100%);
            border: 1px solid #FFE066;
            border-radius: var(--radius-large);
            padding: 1.5rem;
        }

        .tips-title {
            font-size: 1rem;
            font-weight: 600;
            color: #B8860B;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tips-text {
            color: #8B4513;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Graphique moderne */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-large);
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-light);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--text-primary);
        }

        .chart-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .select-wrapper select {
            appearance: none;
            background: var(--bg-card);
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-medium);
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Section détails corrigée */
        .details-section {
            background: var(--bg-card);
            border-radius: var(--radius-large);
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-light);
            margin-top: 2rem;
        }

        .details-toggle {
            text-align: center;
            margin-bottom: 2rem;
        }

        .details-content {
            display: none;
        }

        .details-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            overflow: hidden; /* Correction overflow */
        }

        .detail-stat {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--bg-surface);
            border-radius: var(--radius-medium);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .detail-stat:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .detail-stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .detail-stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            line-height: 1.3;
        }

        /* Navigation vers détails */
        .nav-section {
            text-align: center;
            margin: 3rem 0;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: var(--radius-medium);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .nav-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Responsive amélioré */
        @media (max-width: 1024px) {
            .grid-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .right-column {
                order: -1;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 1rem;
            }

            .details-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            .main-container {
                padding: 0 1rem 2rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .co2-current {
                font-size: 3rem;
            }

            .chart-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations fluides */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* Loading élégant */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Amélioration des détails */
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .controls-section {
            background: var(--bg-surface);
            border-radius: var(--radius-large);
            padding: 1.5rem;
            border: 1px solid var(--border-light);
        }

        .controls-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--text-primary);
        }

        .controls-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>🌱 My Pico</h1>
            <p class="subtitle">Surveillance CO2 intelligente et conseils environnementaux en temps réel</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Stats principales -->
        <div class="stats-overview fade-in">
            <div class="stat-card">
                <div class="stat-value" id="totalDevices">-</div>
                <div class="stat-label">Capteurs actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCo2">-</div>
                <div class="stat-label">PPM Moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalMeasurements">-</div>
                <div class="stat-label">Mesures 24h</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="healthScore">-</div>
                <div class="stat-label">Score Santé</div>
            </div>
        </div>

        <div class="grid-layout">
            <div class="left-column">
                <!-- Niveau CO2 principal -->
                <div class="co2-main fade-in">
                    <div class="co2-current" id="currentCo2">-</div>
                    <div class="co2-unit">PPM CO2</div>
                    <div class="air-quality-badge" id="airQualityBadge">
                        <span>Analyse en cours...</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Dernière mise à jour: <span id="lastUpdate">-</span>
                    </p>
                </div>

                <!-- Graphique principal -->
                <div class="chart-container fade-in">
                    <h3 class="chart-title">📈 Évolution CO2</h3>
                    <div class="chart-controls">
                        <div class="select-wrapper">
                            <select id="timeRange">
                                <option value="1">1 heure</option>
                                <option value="6">6 heures</option>
                                <option value="24" selected>24 heures</option>
                                <option value="72">3 jours</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="refreshChart()">
                            🔄 Actualiser
                        </button>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="co2Chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <!-- Météo -->
                <div class="weather-card fade-in" id="weatherCard">
                    <h4 style="margin-bottom: 1rem; font-weight: 600;">🌤️ Météo locale</h4>
                    <div class="weather-temp" id="weatherTemp">-°C</div>
                    <div class="weather-desc" id="weatherDesc">Chargement...</div>
                    <p style="margin-top: 1rem; opacity: 0.8; font-size: 0.85rem;" id="weatherLocation">-</p>
                </div>

                <!-- Conseils -->
                <div class="advice-card fade-in">
                    <h4 class="advice-title">💡 Conseils personnalisés</h4>
                    <div class="advice-text" id="adviceText">
                        Analyse de la qualité de l'air en cours...
                    </div>
                </div>

                <!-- Tips environnementaux -->
                <div class="tips-card fade-in">
                    <h5 class="tips-title">
                        🌱 Le saviez-vous ?
                    </h5>
                    <div class="tips-text" id="tipsText">
                        Chargement des conseils environnementaux...
                    </div>
                </div>

                <!-- Contrôles -->
                <div class="controls-section fade-in">
                    <h4 class="controls-title">⚙️ Contrôles</h4>
                    <div class="controls-grid">
                        <button class="btn btn-primary" onclick="refreshAll()">
                            🔄 Tout actualiser
                        </button>
                        <button class="btn btn-success" onclick="exportData()">
                            💾 Exporter données
                        </button>
                        <button class="btn btn-warning" onclick="showSettings()">
                            ⚙️ Paramètres
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation vers page détaillée -->
        <div class="nav-section fade-in">
            <a href="/charts" class="nav-link">
                📊 Voir les analyses détaillées
                <span style="font-size: 1.2em;">→</span>
            </a>
        </div>

        <!-- Section détails (corrigée) -->
        <div class="details-section fade-in">
            <div class="details-toggle">
                <button class="btn btn-primary" onclick="toggleDetails()">
                    📊 Aperçu des statistiques
                </button>
            </div>

            <div class="details-content" id="detailsContent">
                <h3 class="section-title">📊 Résumé des 24 dernières heures</h3>
                <div class="details-grid">
                    <div class="detail-stat excellent">
                        <div class="detail-stat-value" id="excellentCount">-</div>
                        <div class="detail-stat-label">Excellent<br>&lt;400 ppm</div>
                    </div>
                    <div class="detail-stat good">
                        <div class="detail-stat-value" id="goodCount">-</div>
                        <div class="detail-stat-label">Bon<br>400-600 ppm</div>
                    </div>
                    <div class="detail-stat medium">
                        <div class="detail-stat-value" id="mediumCount">-</div>
                        <div class="detail-stat-label">Moyen<br>600-1000 ppm</div>
                    </div>
                    <div class="detail-stat bad">
                        <div class="detail-stat-value" id="badCount">-</div>
                        <div class="detail-stat-label">Mauvais<br>1000-1500 ppm</div>
                    </div>
                    <div class="detail-stat danger">
                        <div class="detail-stat-value" id="dangerCount">-</div>
                        <div class="detail-stat-label">Danger<br>&gt;1500 ppm</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="minCo2">-</div>
                        <div class="detail-stat-label">Minimum<br>ppm</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value" id="maxCo2">-</div>
                        <div class="detail-stat-label">Maximum<br>ppm</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let currentData = null;

        // Variables pour les tips rotatifs
        const environmentalTips = [
            "Les plantes d'intérieur peuvent réduire le CO2 et améliorer la qualité de l'air naturellement.",
            "Aérer 5-10 minutes matin et soir suffit pour renouveler l'air intérieur efficacement.",
            "Un taux de CO2 inférieur à 1000 ppm favorise la concentration et le bien-être.",
            "L'air extérieur contient généralement 400-420 ppm de CO2, c'est notre référence naturelle.",
            "Les activités physiques augmentent notre production de CO2, pensez à aérer après le sport.",
            "La cuisson et le chauffage peuvent augmenter significativement le taux de CO2 intérieur.",
            "Un bon sommeil nécessite un air de qualité : visez moins de 1000 ppm dans la chambre.",
            "Les purificateurs d'air éliminent les particules mais n'absorbent pas le CO2.",
        ];

        const adviceByLevel = {
            excellent: {
                title: "🌟 Air excellent !",
                text: "Votre air est de qualité optimale. Maintenez cette qualité en continuant vos bonnes habitudes d'aération."
            },
            good: {
                title: "✅ Bonne qualité d'air",
                text: "L'air est de bonne qualité. Continuez à aérer régulièrement pour maintenir ce niveau."
            },
            medium: {
                title: "⚠️ Qualité moyenne",
                text: "Il serait bon d'aérer un peu. Ouvrez les fenêtres 5-10 minutes pour renouveler l'air."
            },
            bad: {
                title: "🚨 Aérez maintenant !",
                text: "Le taux de CO2 est élevé. Ouvrez immédiatement les fenêtres ou sortez prendre l'air frais."
            },
            danger: {
                title: "🆘 DANGER - Action immédiate !",
                text: "Niveau dangereux ! Évacuez la pièce et aérez complètement. Vérifiez vos équipements."
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initWeatherAPI();
            loadData();
            initChart();
            rotateTips();
            
            // Auto-refresh toutes les 30 secondes
            setInterval(loadData, 30000);
            // Rotation des tips toutes les 10 secondes
            setInterval(rotateTips, 10000);
        });

        async function loadData() {
            try {
                const [latestResponse, statsResponse] = await Promise.all([
                    fetch('/api/data/latest'),
                    fetch('/api/stats')
                ]);

                const latestData = await latestResponse.json();
                const statsData = await statsResponse.json();

                currentData = { latest: latestData, stats: statsData };

                updateMainDisplay(latestData, statsData);
                updateStats(statsData);
                updateAdvice(latestData);

            } catch (error) {
                console.error('Erreur chargement données:', error);
                showError('Erreur de connexion au serveur');
            }
        }

        function updateMainDisplay(latestData, statsData) {
            const device = latestData.devices && latestData.devices[0];
            
            if (device) {
                document.getElementById('currentCo2').textContent = device.co2_ppm;
                document.getElementById('lastUpdate').textContent = 
                    new Date(device.timestamp).toLocaleString('fr-FR');
                
                const badge = document.getElementById('airQualityBadge');
                const quality = getAirQuality(device.co2_ppm);
                badge.className = `air-quality-badge ${quality}`;
                badge.innerHTML = `<span>${getQualityText(quality)}</span>`;
            } else {
                document.getElementById('currentCo2').textContent = '-';
                document.getElementById('lastUpdate').textContent = 'Aucune donnée';
            }
        }

        function updateStats(statsData) {
            document.getElementById('totalDevices').textContent = statsData.total_devices || 0;
            document.getElementById('avgCo2').textContent = statsData.avg_co2 || '-';
            document.getElementById('totalMeasurements').textContent = statsData.total_measurements || 0;
            
            const healthScore = calculateHealthScore(statsData.avg_co2);
            document.getElementById('healthScore').textContent = healthScore + '%';

            document.getElementById('excellentCount').textContent = statsData.excellent_count || 0;
            document.getElementById('goodCount').textContent = statsData.good_count || 0;
            document.getElementById('mediumCount').textContent = statsData.medium_count || 0;
            document.getElementById('badCount').textContent = statsData.bad_count || 0;
            document.getElementById('dangerCount').textContent = statsData.danger_count || 0;
            document.getElementById('minCo2').textContent = statsData.min_co2 || '-';
            document.getElementById('maxCo2').textContent = statsData.max_co2 || '-';
        }

        function updateAdvice(latestData) {
            const device = latestData.devices && latestData.devices[0];
            const adviceElement = document.getElementById('adviceText');
            
            if (device) {
                const quality = getAirQuality(device.co2_ppm);
                const advice = adviceByLevel[quality];
                adviceElement.innerHTML = `<strong>${advice.title}</strong><br>${advice.text}`;
            } else {
                adviceElement.textContent = 'En attente de données des capteurs...';
            }
        }

        function getAirQuality(co2) {
            if (co2 < 400) return 'excellent';
            if (co2 < 600) return 'good';
            if (co2 < 1000) return 'medium';
            if (co2 < 1500) return 'bad';
            return 'danger';
        }

        function getQualityText(quality) {
            const texts = {
                excellent: '🌟 Excellent',
                good: '✅ Bon',
                medium: '⚠️ Moyen',
                bad: '🚨 Mauvais',
                danger: '🆘 Danger'
            };
            return texts[quality] || 'Inconnu';
        }

        function calculateHealthScore(avgCo2) {
            if (!avgCo2) return 0;
            if (avgCo2 < 400) return 100;
            if (avgCo2 < 600) return 90;
            if (avgCo2 < 800) return 75;
            if (avgCo2 < 1000) return 60;
            if (avgCo2 < 1200) return 40;
            if (avgCo2 < 1500) return 20;
            return 10;
        }

        function rotateTips() {
            const tipsElement = document.getElementById('tipsText');
            const randomTip = environmentalTips[Math.floor(Math.random() * environmentalTips.length)];
            tipsElement.textContent = randomTip;
        }

        async function initChart() {
            const ctx = document.getElementById('co2Chart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO2 (ppm)',
                        data: [],
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#007AFF',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#E5E5E7' },
                            ticks: {
                                color: '#86868B',
                                callback: function(value) {
                                    return value + ' ppm';
                                }
                            }
                        },
                        x: {
                            grid: { color: '#E5E5E7' },
                            ticks: { color: '#86868B' }
                        }
                    }
                }
            });

            await refreshChart();
        }

        async function refreshChart() {
            const hours = document.getElementById('timeRange').value;
            
            try {
                const response = await fetch(`/api/data/history?hours=${hours}`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    const labels = data.data.map(point => 
                        new Date(point.time).toLocaleTimeString('fr-FR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })
                    );
                    const values = data.data.map(point => point.co2_ppm);
                    
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = values;
                    chart.update();
                }
            } catch (error) {
                console.error('Erreur graphique:', error);
            }
        }

        async function initWeatherAPI() {
            try {
                setTimeout(() => {
                    document.getElementById('weatherTemp').textContent = '22°C';
                    document.getElementById('weatherDesc').textContent = 'Ensoleillé';
                    document.getElementById('weatherLocation').textContent = 'Paris, France';
                }, 1000);
            } catch (error) {
                console.error('Erreur météo:', error);
                document.getElementById('weatherDesc').textContent = 'Indisponible';
            }
        }

        function toggleDetails() {
            const content = document.getElementById('detailsContent');
            const button = event.target;
            
            content.classList.toggle('show');
            
            if (content.classList.contains('show')) {
                button.textContent = '📊 Masquer les statistiques';
            } else {
                button.textContent = '📊 Aperçu des statistiques';
            }
        }

        function refreshAll() {
            loadData();
            refreshChart();
            initWeatherAPI(); 
            rotateTips();
            
            const btn = event.target;
            btn.textContent = '⏳ Actualisation...';
            setTimeout(() => {
                btn.textContent = '🔄 Tout actualiser';
            }, 2000);
        }

        function exportData() {
            if (currentData) {
                const dataStr = JSON.stringify(currentData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `mypico-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        function showSettings() {
            alert('Paramètres à venir dans une prochaine version !');
        }

        function showError(message) {
            const error = document.createElement('div');
            error.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--danger);
                color: white;
                padding: 1rem 2rem;
                border-radius: var(--radius-medium);
                box-shadow: var(--shadow-large);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            error.textContent = message;
            document.body.appendChild(error);
            
            setTimeout(() => {
                error.remove();
            }, 5000);
        }

        document.getElementById('timeRange').addEventListener('change', refreshChart);
    </script>
</body>
</html> 